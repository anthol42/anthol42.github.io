<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
  <link rel="icon" type="image/x-icon" href="/backtestpro/assets/favicon.ico?">
  <link href='/backtestpro/assets/bootstrap.min.css' rel='stylesheet', type='text/css'>
  <link href="/backtestpro/assets/style.css" rel="stylesheet" type="text/css">
  <link href="/backtestpro/assets/notebook.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" crossorigin="anonymous" />
  <link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
  <script src="/backtestpro/assets/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>
  <title>How to Backtest</title>
  <meta name="description" content="A tutorial on how to use the BacktestPro Framework." />
    <!-- Load mathjax -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS_CHTML-full,Safe"></script>
    <!-- MathJax configuration -->
    <script type="text/x-mathjax-config">
        init_mathjax = function() {
            if (window.MathJax) {
            // MathJax loaded
                MathJax.Hub.Config({
                    TeX: {
                        equationNumbers: {
                        autoNumber: "AMS",
                        useLabelIds: true
                        }
                    },
                    tex2jax: {
                        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
                        processEscapes: true,
                        processEnvironments: true
                    },
                    displayAlign: 'center',
                    CommonHTML: {
                        linebreaks: {
                        automatic: true
                        }
                    },
                    messageStyle: "none"
                });

                MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
            }
        }
        init_mathjax();
    </script>
    <!-- End of mathjax configuration -->
    <script type="module">
        document.addEventListener("DOMContentLoaded", async () => {
          const diagrams = document.querySelectorAll(".jp-Mermaid > pre.mermaid");
          // do not load mermaidjs if not needed
          if (!diagrams.length) {
            return;
          }
          const mermaid = (await import("https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.7.0/mermaid.esm.min.mjs")).default;
          const parser = new DOMParser();

          mermaid.initialize({
            maxTextSize: 100000,
            maxEdges: 100000,
            startOnLoad: false,
            fontFamily: window
              .getComputedStyle(document.body)
              .getPropertyValue("--jp-ui-font-family"),
            theme: document.querySelector("body[data-jp-theme-light='true']")
              ? "default"
              : "dark",
          });

          let _nextMermaidId = 0;

          function makeMermaidImage(svg) {
            const img = document.createElement("img");
            const doc = parser.parseFromString(svg, "image/svg+xml");
            const svgEl = doc.querySelector("svg");
            const { maxWidth } = svgEl?.style || {};
            const firstTitle = doc.querySelector("title");
            const firstDesc = doc.querySelector("desc");

            img.setAttribute("src", `data:image/svg+xml,${encodeURIComponent(svg)}`);
            if (maxWidth) {
              img.width = parseInt(maxWidth);
            }
            if (firstTitle) {
              img.setAttribute("alt", firstTitle.textContent);
            }
            if (firstDesc) {
              const caption = document.createElement("figcaption");
              caption.className = "sr-only";
              caption.textContent = firstDesc.textContent;
              return [img, caption];
            }
            return [img];
          }

          async function makeMermaidError(text) {
            let errorMessage = "";
            try {
              await mermaid.parse(text);
            } catch (err) {
              errorMessage = `${err}`;
            }

            const result = document.createElement("details");
            result.className = 'jp-RenderedMermaid-Details';
            const summary = document.createElement("summary");
            summary.className = 'jp-RenderedMermaid-Summary';
            const pre = document.createElement("pre");
            const code = document.createElement("code");
            code.innerText = text;
            pre.appendChild(code);
            summary.appendChild(pre);
            result.appendChild(summary);

            const warning = document.createElement("pre");
            warning.innerText = errorMessage;
            result.appendChild(warning);
            return [result];
          }

          async function renderOneMarmaid(src) {
            const id = `jp-mermaid-\${_nextMermaidId++}`;
            const parent = src.parentNode;
            let raw = src.textContent.trim();
            const el = document.createElement("div");
            el.style.visibility = "hidden";
            document.body.appendChild(el);
            let results = null;
            let output = null;
            try {
              let { svg } = await mermaid.render(id, raw, el);
              svg = cleanMermaidSvg(svg);
              results = makeMermaidImage(svg);
              output = document.createElement("figure");
              results.map(output.appendChild, output);
            } catch (err) {
              parent.classList.add("jp-mod-warning");
              results = await makeMermaidError(raw);
              output = results[0];
            } finally {
              el.remove();
            }
            parent.classList.add("jp-RenderedMermaid");
            parent.appendChild(output);
          }


          /**
           * Post-process to ensure mermaid diagrams contain only valid SVG and XHTML.
           */
          function cleanMermaidSvg(svg) {
            return svg.replace(RE_VOID_ELEMENT, replaceVoidElement);
          }


          /**
           * A regular expression for all void elements, which may include attributes and
           * a slash.
           *
           * @see https://developer.mozilla.org/en-US/docs/Glossary/Void_element
           *
           * Of these, only `<br>` is generated by Mermaid in place of `\n`,
           * but _any_ "malformed" tag will break the SVG rendering entirely.
           */
          const RE_VOID_ELEMENT =
            /<\s*(area|base|br|col|embed|hr|img|input|link|meta|param|source|track|wbr)\s*([^>]*?)\s*>/gi;

          /**
           * Ensure a void element is closed with a slash, preserving any attributes.
           */
          function replaceVoidElement(match, tag, rest) {
            rest = rest.trim();
            if (!rest.endsWith('/')) {
              rest = `${rest} /`;
            }
            return `<${tag} ${rest}>`;
          }

          void Promise.all([...diagrams].map(renderOneMarmaid));
        });
    </script>
</head>
<body>
  <nav class="navbar navbar-light navbar-expand bg-light fixed-top shadow-sm" id="navbar-main">
    <div class="navbar-container" style="padding-left: 20px">
            <a class="navbar-brand logo" href="/backtestpro">
                <img alt="Logo image" class="logo__image only-light" src="/backtestpro/assets/logo_light.svg">
            </a>
            <div class="col-lg-9 navbar">
                <div class="mr-auto" id="navbar-center">

                    <div class="navbar-center-item">
                        <ul class="navbar-nav" id="navbar-main-elements">
                            <li class="toctree-l1 nav-item">
                                <a class="reference internal nav-link" href="/backtestpro">
                                    Home
                                </a>
                            </li>

                            <li class="toctree-l1 nav-item">
                                <a class="reference internal nav-link" href="/backtestpro/get_started.html">
                                    Get Started
                                </a>
                            </li>

                            <li class="toctree-l1 nav-item">
                                <a class="reference internal nav-link active" href="/backtestpro/tutorials">
                                    Tutorials
                                </a>
                            </li>

                            <li class="toctree-l1 nav-item">
                                <a class="reference internal nav-link" href="/backtestpro/docs/backtest">
                                    Documentation
                                </a>
                            </li>


                            <li class="nav-item">
                                <a class="nav-link nav-external" href="/backtestpro/about.html">About</a>
                            </li>

                        </ul>
                    </div>

                </div>

                <div id="navbar-end">

                    <div class="navbar-end-item">
                        <code class="navbar-version">v0.1.1</code>
                    </div>

                    <div class="navbar-end-item">
                        <ul aria-label="Icon Links" class="navbar-nav" id="navbar-icon-links">
                            <li class="nav-item">
                                <a class="nav-link" href="https://github.com/anthol42/backtestPro" rel="noopener" target="_blank"
                                   title="GitHub"><img alt="GitHub" class="icon-link" src="/backtestpro/assets/github-mark.svg"
                                                       style="height: 1.2em; margin: 0px; padding: 0px;"></a>
                            </li>
                        </ul>
                    </div>

                </div>
            </div>
    </div>
</nav>
    <div class="row" style="margin-right: 0;">
    <!-- Table of Contents Section -->
    <div id="tableOfContents" class="col-md-3" style="width: 300px">
    <nav id="toc">
        <ul class="nav flex-column">
            <li class="nav-item nav-item-dynamic">
                <a class="nav-link"  style="color: rgb(137, 137, 137)" href="/backtestpro/tutorials">Home</a>
            </li>
                <li class="nav-item nav-item-dynamic">
                    <a class="nav-link" style="color: rgb(137, 137, 137)" href="/backtestpro/tutorials/Data_Pipelines.html">Data Pipelines</a>
                </li>
                <li class="nav-item nav-item-dynamic">
                    <a class="nav-link" style="color: rgb(34, 34, 34)" href="/backtestpro/tutorials/How_to_Backtest.html">How To Backtest</a>
                </li>
        </ul>
    </nav>
    </div>
    <div class="toc-doc">
        <div class="notebook-container">
            <main class="jp-Notebook" data-jp-theme-light="true" data-jp-theme-name="JupyterLab Light">
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=979d285f-e25d-4785-a0a1-76a482eb3a57">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h1 id="How-to-backtest">How to backtest<a class="anchor-link" href="#How-to-backtest">¶</a></h1><p>This tutorial will show you an overview of how to use the framework to do backtest.  It assumes that you are already familiar with the <code>data</code> module. The primary module that will be used in this tutorial is the <code>engine</code> module.</p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=d4094261-ef95-4461-871c-59c2c9bb45c3">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="The-normal-structure-of-a-backtest-project">The normal structure of a backtest project<a class="anchor-link" href="#The-normal-structure-of-a-backtest-project">¶</a></h2><p>Usually, a backtest project should have these sections:</p>
<ul>
<li>The data pipeline</li>
<li>The strategy definition</li>
<li>The backtest configuration</li>
<li>The analysis of the results</li>
</ul>
<p>Each section could be in the same file for a small project, in different files for a bigger project and maybe also in different directories for even larger projects.</p>
<p>In the get_started section of the official documentation, there is a an example.  We will walk through the example to see where each parts are found.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">backtest</span> <span class="kn">import</span> <span class="n">Strategy</span><span class="p">,</span> <span class="n">Backtest</span>
<span class="kn">from</span> <span class="nn">backtest.indicators</span> <span class="kn">import</span> <span class="n">IndicatorSet</span><span class="p">,</span> <span class="n">TA</span>
<span class="kn">from</span> <span class="nn">backtest.data</span> <span class="kn">import</span> <span class="n">FetchCharts</span><span class="p">,</span> <span class="n">ToTSData</span><span class="p">,</span> <span class="n">Cache</span><span class="p">,</span> <span class="n">PadNan</span>
<span class="kn">import</span> <span class="nn">backtest.engine.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># --------------------------------------------------------------------------------------------------------------</span>
<span class="c1"># Section A</span>
<span class="k">class</span> <span class="nc">MyStrategy</span><span class="p">(</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">timestep</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">tickers</span><span class="p">:</span>
            <span class="n">chart</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">main</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span><span class="o">.</span><span class="n">chart</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chart</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">F</span><span class="o">.</span><span class="n">crossover</span><span class="p">(</span><span class="n">chart</span><span class="p">[</span><span class="s2">"MACD"</span><span class="p">],</span> <span class="n">chart</span><span class="p">[</span><span class="s2">"MACD_SIGNAL"</span><span class="p">])</span> <span class="ow">and</span> <span class="n">chart</span><span class="p">[</span><span class="s2">"MACD"</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ticker</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">long</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">buy_long</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">long</span> <span class="ow">and</span> <span class="n">F</span><span class="o">.</span><span class="n">crossunder</span><span class="p">(</span><span class="n">chart</span><span class="p">[</span><span class="s2">"MACD"</span><span class="p">],</span> <span class="n">chart</span><span class="p">[</span><span class="s2">"MACD_SIGNAL"</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">sell_long</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="c1"># End of section A</span>
<span class="c1"># --------------------------------------------------------------------------------------------------------------</span>


<span class="c1"># --------------------------------------------------------------------------------------------------------------</span>
<span class="c1"># Section B</span>
<span class="n">TICKERS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"META"</span><span class="p">,</span> <span class="s2">"AMZN"</span><span class="p">,</span> <span class="s2">"AAPL"</span><span class="p">,</span> <span class="s2">"NVDA"</span><span class="p">,</span> <span class="s2">"GOOGL"</span><span class="p">,</span> <span class="s2">"MSFT"</span><span class="p">,</span> <span class="s2">"TSLA"</span><span class="p">]</span>
<span class="n">data_pipeline</span> <span class="o">=</span> <span class="n">FetchCharts</span><span class="p">(</span><span class="n">TICKERS</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">|</span> <span class="n">PadNan</span><span class="p">()</span> <span class="o">|</span> <span class="n">ToTSData</span><span class="p">()</span> <span class="o">|</span> <span class="n">Cache</span><span class="p">()</span>
<span class="c1"># End of section B</span>
<span class="c1"># --------------------------------------------------------------------------------------------------------------</span>

<span class="c1"># --------------------------------------------------------------------------------------------------------------</span>
<span class="c1"># Section C</span>
<span class="n">bt</span> <span class="o">=</span> <span class="n">Backtest</span><span class="p">(</span><span class="n">data_pipeline</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2010</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
              <span class="n">strategy</span><span class="o">=</span><span class="n">MyStrategy</span><span class="p">(),</span>
              <span class="n">indicators</span><span class="o">=</span><span class="n">IndicatorSet</span><span class="p">(</span><span class="n">TA</span><span class="o">.</span><span class="n">MACD</span><span class="p">()))</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="c1"># End of section C</span>
<span class="c1"># --------------------------------------------------------------------------------------------------------------</span>

<span class="c1"># --------------------------------------------------------------------------------------------------------------</span>
<span class="c1"># Section D</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="c1"># End of section D</span>
<span class="c1"># --------------------------------------------------------------------------------------------------------------</span>
</pre></div>
<p>In the example the section:</p>
<ul>
<li>A) Defines the strategy</li>
<li>B) Defines the data pipeline</li>
<li>C) Configures and runs the backtest</li>
<li>D) Analyse the results</li>
</ul>
<p>As you can see, all of these sections are fairly simple in that example, but can become extensivly complex if needed.  The syntax is really flexible.</p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=17b1f5b4-d431-4bfe-9dca-71f965c3b651">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="Strategy">Strategy<a class="anchor-link" href="#Strategy">¶</a></h2><p>In this section, you will see how to create a strategy that fits your need.  You will see how to interact with the bank account, the broker and the portfolio.</p>
<h3 id="1.-Derive-the-class">1. Derive the class<a class="anchor-link" href="#1.-Derive-the-class">¶</a></h3><p>The first step is to derive a class from the <code>Strategy</code> class.  The only required method to implement is the <code>run</code> method.  This is where the logic of the strategy is implemented.  It can be simple if-else clauses, it can be some decision trees or complex machine learning algorithms.  You can also override the __init__ method to add some dynamic attributes to your class.  You can add any method you want and attributes you want with two exceptions: <code>init</code> and <code>__call__</code>.  You should not override those methods.  Notice that it is written <code>init</code> not <code>__init__</code>.</p>
<p>When a strategy is release using the serve module its state needs to be saved to disk.  To do so, there is a default save and load method implemented that store the state as a pickle file.  If you want to store the state in another format, you can override those methods.</p>
<h3 id="2.-Data-Interaction">2. Data Interaction<a class="anchor-link" href="#2.-Data-Interaction">¶</a></h3><p>The run method is called at every step and passes the current data to the strategy via the data parameter.  This parameter contains a <code>RecordsBucket</code> object.  This object contains few attributes defined below.  This object contains all the records(charts) of all assets across all time resolutions (if multiple were used).  To access a given time resolution, you can use the <code>[]</code> operator with the desired <code>timedelta</code> object or its index in the <code>available_time_res</code> attribute.  This will return a <code>Records</code> object.  The <code>main</code> attribute is an alias to access the <code>Records</code> object associated with the main time resolution.</p>
<p>The <code>Records</code> is sort of a set of individual <code>Record</code> for a single time resolution.  Each record contains the price chart of the asset and all the added features, but also some other information such as the rate of dividends (quarterly, annually, etc).  The data is kind of structured as a tree:</p>
<pre><code>RecordsBucket
├ Records
┊ ┕ Record
┊ ┊  ┕ pd.DataFrame (The chart)
</code></pre>
<h3 id="3.-Interactions-with-the-Account">3. Interactions with the Account<a class="anchor-link" href="#3.-Interactions-with-the-Account">¶</a></h3><p>It can be useful to know how much available cash remains in the account to calculate how much money to invest in a trade.  To do so, you can interact with the account that is referenced as the <code>account</code> attribute of the Strategy.  It is directly connected to the backtest engine.  It is strongly recommonded to not modify the state of the account for example depositing money or adding collateral, even though nothing blocks you from modifying doing because it could cause bugs and give wrong backtest results.  What you can do with the account is access the <code>available_cash</code> property, the <code>collateral</code> property or the <code>transactions</code> property, but make sure you do not modify it.</p>
<h3 id="4.-Interactions-with-the-portfolio">4. Interactions with the portfolio<a class="anchor-link" href="#4.-Interactions-with-the-portfolio">¶</a></h3><p>It can be useful to know what positions are currently open to perform actions.  To do so, yoi can access the <code>porfolio</code> attribute of the Strategy.  Again, you must not modify its state.  You can access the <code>long</code> or the <code>short</code> attributes to access the open positions.  Again, make sure to not modify anything.</p>
<h3 id="5.-Interaction-with-the-broker">5. Interaction with the broker<a class="anchor-link" href="#5.-Interaction-with-the-broker">¶</a></h3><p>Your strategy will interact with the broker to open/close positions.  You can use these methods:</p>
<ul>
<li><code>buy_long</code>: to open a long position</li>
<li><code>sell_long</code>: to close a long position</li>
<li><code>sell_short</code>: to open a short position</li>
<li><code>buy_short</code>: to close a short position.</li>
</ul>
<p>You must not change the state of the broker other than from these methods, again to avoid bugs and false results.  If you want to know what are the pending transactions, you can access the the <code>pending_orders</code> property of the broker.</p>
<h3 id="Example">Example<a class="anchor-link" href="#Example">¶</a></h3><p>In the following example, we will implement a Strategy that buys a security when the daily 7 day simple moving average start increasing and the candle is over the weekly 50 days simple moving average.  It sells if the 7 day moving average start decreasing.  It will invest one third of the available cash in any trade.</p>
<p><strong>Features used in the example:</strong></p>
<ul>
<li>Data interactions with multiple time resolutions</li>
<li>Interaction with the account to know how much cash is available</li>
<li>Interaction with the portfolio to know if a given position is open</li>
<li>Interaction with the broker to trade.</li>
</ul>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=c3bde0c7-ab09-47f0-8611-d4f4632a0d58">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">

<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">MyStrategy</span><span class="p">(</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">timestep</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">tickers</span><span class="p">:</span>
            <span class="n">main_chart</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">main</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span><span class="o">.</span><span class="n">chart</span>
            <span class="n">w_chart</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">timedelta</span><span class="p">(</span><span class="n">weeks</span><span class="o">=</span><span class="mi">1</span><span class="p">)][</span><span class="n">ticker</span><span class="p">]</span><span class="o">.</span><span class="n">chart</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">w_chart</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span><span class="n">w_chart</span><span class="p">[[</span><span class="s2">"Open"</span><span class="p">,</span> <span class="s2">"Close"</span><span class="p">]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">w_chart</span><span class="p">[</span><span class="s1">'SMA(50)'</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">F</span><span class="o">.</span><span class="n">ascending</span><span class="p">(</span><span class="n">main_chart</span><span class="p">[</span><span class="s2">"SMA(14)"</span><span class="p">])</span> <span class="ow">and</span> <span class="n">ticker</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">long</span><span class="p">:</span>
                    <span class="n">price</span> <span class="o">=</span> <span class="n">main_chart</span><span class="p">[</span><span class="s2">"Close"</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                    <span class="n">amount</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">available_cash</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">//</span> <span class="n">price</span>   <span class="c1"># Invest always 1 third of the available cash</span>
                    <span class="k">if</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">buy_long</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">long</span> <span class="ow">and</span> <span class="n">F</span><span class="o">.</span><span class="n">descending</span><span class="p">(</span><span class="n">main_chart</span><span class="p">[</span><span class="s2">"SMA(14)"</span><span class="p">]):</span>
                <span class="n">n_stocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">long</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span><span class="o">.</span><span class="n">amount</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">sell_long</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">n_stocks</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=c7ce9bd9-59d4-46c7-b8bf-2b884c472ca0">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="Backtest">Backtest<a class="anchor-link" href="#Backtest">¶</a></h2><p>In this section, you will learn how to configure a backtest object to fit your specific needs.  We will use the above strategy and test it on a 10y backtest from 2010 to 2020.</p>
<p>There are multiple parameters that can be set to customize the way the backtest will work.  For example, we can Add technical indicators (or more generally time-series generated from the data) - <code>indicators</code> parameter - that are computed on the fly on the window shown to the strategy.  Calculating the indicators that way takes more time (more compute intensive), but the results should be closer to reality.</p>
<p>Another parameter that can be set is the <code>TimeResExtender</code>.  This is an object that will extend the time resolution to other.  For example, if the only time resolution fetch by the data pipeline is 1h, we could setup a TimeResExtender object to make new available time resolution such as daily or weekly.  These will be available like any other time resolution fetch from a data pipeline from the <code>RecordsBucket</code> object.</p>
<p>We can also tune the <code>window</code> size: the number of days in the past the strategy can see.</p>
<p>Also, you can change the initial cash by providing a number to the <code>initial_cash</code> parameter.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=e90fa71f-155b-4074-8e5b-3c1571668abc">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">

<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">backtest</span> <span class="kn">import</span> <span class="n">Backtest</span>
<span class="kn">from</span> <span class="nn">backtest.indicators</span> <span class="kn">import</span> <span class="n">IndicatorSet</span><span class="p">,</span> <span class="n">TA</span>
<span class="kn">from</span> <span class="nn">backtest.data</span> <span class="kn">import</span> <span class="n">FetchCharts</span><span class="p">,</span> <span class="n">ToTSData</span><span class="p">,</span> <span class="n">Cache</span><span class="p">,</span> <span class="n">PadNan</span>
<span class="kn">from</span> <span class="nn">backtest.engine</span> <span class="kn">import</span> <span class="n">BasicExtender</span><span class="p">,</span> <span class="n">TimePeriod</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="c1"># The magnificent 7 tickers</span>
<span class="n">TICKERS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"META"</span><span class="p">,</span> <span class="s2">"AMZN"</span><span class="p">,</span> <span class="s2">"AAPL"</span><span class="p">,</span> <span class="s2">"NVDA"</span><span class="p">,</span> <span class="s2">"GOOGL"</span><span class="p">,</span> <span class="s2">"MSFT"</span><span class="p">,</span> <span class="s2">"TSLA"</span><span class="p">]</span>
<span class="n">data_pipeline</span> <span class="o">=</span> <span class="n">FetchCharts</span><span class="p">(</span><span class="n">TICKERS</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">|</span> <span class="n">PadNan</span><span class="p">()</span> <span class="o">|</span> <span class="n">ToTSData</span><span class="p">()</span> <span class="o">|</span> <span class="n">Cache</span><span class="p">()</span>
<span class="n">bt</span> <span class="o">=</span> <span class="n">Backtest</span><span class="p">(</span><span class="n">data_pipeline</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2010</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
              <span class="n">window</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span>
              <span class="n">initial_cash</span><span class="o">=</span><span class="mi">10_000</span><span class="p">,</span>
              <span class="n">strategy</span><span class="o">=</span><span class="n">MyStrategy</span><span class="p">(),</span>
              <span class="n">indicators</span><span class="o">=</span><span class="n">IndicatorSet</span><span class="p">(</span><span class="n">TA</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span> <span class="n">TA</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="mi">50</span><span class="p">)),</span>
              <span class="n">time_res_extender</span><span class="o">=</span><span class="n">BasicExtender</span><span class="p">(</span><span class="n">TimePeriod</span><span class="o">.</span><span class="n">ONE_WEEK</span><span class="p">))</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Saving results..."</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">"tmp_results.bcktst"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">

<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre>Backtesting...:   0%|                                                                                                                                                                     | 0/2265 [00:00&lt;?, ?it/s]/Users/alavertu/PycharmProjects/backtestPro/venv/lib/python3.12/site-packages/backtest/engine/backtest.py:700: UnexpectedBehaviorRisk: This method is not guaranteed to work for your setup.  You should override it, or make sure it works for your setup if you have series that have a higher resolution than the main resolution.
  warnings.warn("This method is not guaranteed to work for your setup.  You should override it, or make sure it "
Backtesting...: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2265/2265 [05:34&lt;00:00,  6.76it/s]
</pre>
</div>
</div>
<div class="jp-OutputArea-child">

<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Backtest results for MyStrategy from 2010-12-30 00:00:00 to 2019-12-31 00:00:00:
	Duration:                    3288 days 00:00:00
	Exposure time [days]:        2999.0
	Initial cash [$]:            10000
	External cash variation [$]: 0.0
	Equity final [$]:            71075.4714374238
	Equity peak [$]:             72401.37303540048
	Returns [%]:                 610.7547143742379
	Index Returns [%]:           None
	Annual returns [%]:          24.322341586376936
	Sharp ratio:                 1.0719929733853757
	Sortino ratio:               2.2044702077404934
	Max drawdown [%]:            20.40702361196548
	Avg drawdown [%]:            13.041929797595417
	Calmar ratio:                None
	Num trades:                  1469
	Num exits:                   729
	Win rate [%]:                39.91769547325103
	Best trade [%]:              133.37151584574266
	Worst trade [%]:             -13.683227784615005
	Avg trade [%]:               1.1232226274537158
	Max trade duration [days]:   138.0
	Avg trade duration [days]:   15.762345679012347
	Min trade duration [days]:   0.0
	Profit factor:               1.5826997756958008
	SQN:                         3.2848366112654817

Saving results...
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=7c5ce1fd-6098-465f-a6b9-9111b6c654d2">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<hr/>
<p>Now, let's say you want to add money into your account monthly, or weekly, you can with a <code>CashController</code>!  CashController objects manage money flow in and out of the account outside of the trading mecanism.  The object is called at every day, every week, every month and every year.  This means that you can derive the base class and make your own CashController.</p>
<p>However, if you just want to add or remove a fix amount of cash weekly, for example, you can use the SimpleCashController class and just pass the amount you want to add or remove weekly.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">backtest.engine</span> <span class="kn">import</span> <span class="n">SimpleCashController</span>
<span class="n">controller</span> <span class="o">=</span> <span class="n">SimpleCashController</span><span class="p">(</span><span class="n">every_week</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
<hr/>
<p>If you want to design more complex mecanism, you can derive the class and override the corresponding method: <code>every_day</code>, <code>every_week</code>, <code>every_month</code> and/or <code>every_year</code>.  From any of these methods, you can access the bank account, the broker and the strategy object from '<em>self</em>'.  This way, the CashController could add money conditionally to the available cash into the account.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">backtest.engine</span> <span class="kn">import</span> <span class="n">CashControllerBase</span>

<span class="k">class</span> <span class="nc">CustomCashController</span><span class="p">(</span><span class="n">CashControllerBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">every_week</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">available_cash</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">10_000</span><span class="p">,</span> <span class="s2">"Fund deposit"</span>
</pre></div>
<hr/>
<p>To use it, pass the CashController object to the <code>cash_controller</code> parameter of the backtest object.</p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=c46549ee-373d-4a6f-9692-d41cc449bb05">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>To ensure that results are reproductable, a lot of information (metadata) is saved with the results of the backtest.  Those informations can be the system information, the strategy name and version ,the author of the code, etc.  Most of the information is acquired automatically (need to be in a git repository), but can be overriden.  For example, the name of the startegy is, by default, the name of the class.  However, if for some reason, you want to use another name, you can pass a string to the <code>strategy_name</code> parameter of the <code>Metadata</code> object.  You can also pass a lot of different informations to ensure that the results are reproductible.  Another example could be to provide a <code>description</code> that gives a detailed explanation on how to run the backtest in the same conditions (which tickers, timeframe, <em>etc</em>).  The metadata object is passed to the Backtest object during its initialization, and is used by the same object during the saving of the results.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=f0fbed95-69dc-402e-9d38-4f474de33cf7">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">

<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">backtest.engine</span> <span class="kn">import</span> <span class="n">Metadata</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">Metadata</span><span class="p">(</span>
    <span class="n">strategy_name</span> <span class="o">=</span> <span class="s2">"MyStrat"</span><span class="p">,</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">"# This is my description"</span><span class="p">,</span>
    <span class="n">version</span> <span class="o">=</span> <span class="s1">'0.1.0'</span><span class="p">,</span>
    <span class="n">author</span> <span class="o">=</span> <span class="s1">'myself'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</main>
        </div>
    </div>
    </div>
  <div class="divider"></div>
  <footer id="footer">
    <div id="footer_container">
    <p><b>Author</b>: Anthony Lavertu (2024)</p>
    <p><b>Generated by</b> <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</div>
</footer>
</body>
  <script>
function copyToClipboard(button) {
      var preElement = button.parentNode.previousElementSibling;
      var codeElement = preElement.querySelector('code');
      var codeText = codeElement.textContent || codeElement.innerText;

      navigator.clipboard.writeText(codeText).then(function() {
        button.innerHTML = '<i class="far fa-check-circle"></i>';
        button.classList.add('copied');

        setTimeout(function() {
          button.innerHTML = '<i class="far fa-copy"></i>';
          button.classList.remove('copied');
        }, 3000);
      }).catch(function(error) {
        console.error('Failed to copy: ', error);
      });
    }
    function copyToClipboardText(button, id) {
    const codeText = codeTexts[id];
    navigator.clipboard.writeText(codeText).then(function() {
        button.innerHTML = '<i class="far fa-check-circle"></i>';
        button.classList.add('copied');

        setTimeout(function() {
          button.innerHTML = '<i class="far fa-copy"></i>';
          button.classList.remove('copied');
        }, 3000);
      }).catch(function(error) {
        console.error('Failed to copy: ', error);
      });
    }
        document.addEventListener('DOMContentLoaded', function() {
      // Get all section links
      const sectionLinks = document.querySelectorAll('#toc a');
    });
  </script>
</html>